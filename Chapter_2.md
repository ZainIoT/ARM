# 2 ARM微处理器概述与编程模型

## 2.1 ARM微处理器概述

**ARM（advanced RISC machines）** 有三种含义：

1. 它是一个**公司名称**
2. 是一类微处理器的**通称**
3. 是一种**技术的名称**

### 2.1.1 ARM微处理器的特点

采用RSIC架构的ARM微处理器有如下特点：

1. 体积小、低功耗、低成本、高性能；
2. 支持Thumb（16位）/ARM（32位）双指令集，能很好的兼容8位/16位器件；
3. 大量使用寄存器，**指令执行速度快**；
4. 大多数数据操作都在寄存器中完成；
5. 寻址方式灵活简单，执行效率高；
6. 指令长度固定。

## 2.2 ARM微处理器结构

### 2.2.2 ARM微处理器寄存器结构

ARM处理器共有 **37** 个寄存器，被分为若干个组（BANK）

* **31** 个**通用寄存器**；（包括程序计数器（PC指针），均为32位寄存器）
* **6** 个**状态寄存器**。（用以标识CPU的工作状态及程序的运行状态，均为32位寄存器）

## 2.3 ARM微处理器的工作状态

> ARM微处理器的**工作状态**有**两种**，并可在两种状态之间切换
> * **ARM状态**    此时处理器执行**32**位的**字对齐**的ARM指令
> * **Thumb状态**  此时处理器执行**16**位的**半字对齐**的Thumb指令

!> 注意：ARM处理器在开始执行代码时，应处于ARM状态！！！

* 进入 Thumb 状态：
  当操作数寄存器的状态位（位0）为1时，可采用执行 BX 指令的方法，使微处理器从ARM状态切换到Thumb状态。
  当处理器处于Thumb状态时发生异常，则异常处理返回时，自动切换到Thumb状态。

* 进入 ARM 状态：
  当操作数寄存器的状态位（位0）为0时，可采用执行 BX 指令的方法，使微处理器从Thumb状态切换到ARM状态。
  在处理器进行异常处理时，把PC指针放入异常模式链接寄存器中，并从异常向量地址开始执行程序，也可以使处理器切换到ARM状态。

## 2.4 ARM体系结构的存储器格式

> ARM体系结构将存储器看作是从零地址开始的字节的线性组合。从零字节到三字节放置第一个存储的字数据，从第四个字节到第七个字节放置第二个存储的字数据，依次排列。作为32位的微处理器,ARM体系结构所支持的最大录址空间为4GB($2^{32}$字节)。

ARM体系结构可以用**两种方法存储字数据**，称之为**大端格式**和**小端格式**具体说明如下：

1.**大端格式**：
字数据的*高字节*存储在*低地址*中，而字数据的*低字节*则存放在*高地址*；

2.**小端格式**：（与大端格式相反）
字数据的*高字节*存储在*高地址*中，而字数据的*低字节*则存放在*低地址*；

**下面我将使用一个详细的示例来解释两种存储格式**：
32位的整数0x12345678存放到一个整型变量（int）中，这个整型变量采用大端或者小端格式在内存中的存储由下表所示。使用Byte_3表示一个32位数据的最高字节，使用Byte_0表示一个32位数据最低字节。

|地址|大端模式|小端模式|
|:--:|:--:|:--:|
0x00（低地址）|12（Byte_3）|78（Byte_0）
0x01 ↓|34（Byte_2）|56（Byte_1）
0x02 ↓|56（Byte_1）|34（Byte_2）
0x03（高地址）|78（Byte_0）|12（Byte_3）

## 2.5 处理器模式

ARM微处理器支持7中运行模式：

1. usr → **用户模式** ：ARM处理器正常的程序执行状态；
2. fiq → **快速中断模式** ：用于高速数据传输或通道处理；
3. irq → **外部中断模式** ：用于通用的中断处理；
4. svc → **管理模式** ：操作系统使用的保护模式；
5. abt → **数据访问终止模式** ：当数据或指令预取终止时进入该模式，可用于虚拟内存及存储保护；
6. sys → **系统模式** ：运行具有特权的操作系统任务；
7. und → **未定义指令终止模式** ：当未定义的指令执行时进入该模式，可用于支持硬件协处理器的软件仿真。

!> 除**用户模式**外，其余6种模式称为**非用户模式**或**特权模式**；<br>除**用户模式**和**系统模式**外的5种模式，称为**异常模式**，常用于处理中断或异常、以及需要访问受保护的系统资源等情况。

## 2.6 寄存器组织

> ARM微处理器中的寄存器不能被同时访问，具体哪些寄存器是可编程访问的，取决于微处理器的工作状态及具体的运行模式。但在任何时候，通用寄存器**R0~R14**、**程序计数器PC**、一个或两个状态寄存器都是可访问的。

### 2.6.1 ARM状态下的寄存器组织

#### 1.通用寄存器

通用寄存器包括**R0~R15**，可以分为三类：

* 未分组寄存器 **R0~R7**
* 分组寄存器 **R8~R14**
* 程序计数器 **PC（R15）**

<!-- tabs:start -->

#### ** 未分组寄存器 **

在所有的运行模式下，未分组寄存器都指向同一个物理寄存器，它们未被系统用作特殊的用途，因此，在中断或异常处理进行运行模式转换时，由于不同的处理器运行模式均使用相同的物理寄存器，可能会造成寄存器中数据的破坏，这一点在进行程序设计时应引起注意。

#### ** 分组寄存器 **

#### R8~R12

对于分组寄存器，它们每一次所访问的物理寄存器与处理器当前的运行模式有关。
对于 **R8~R12** 来说，每个寄存器对应两个不同的物理理寄存器：

* 当使用 **fiq（快速中断模式）** 模式时，访问寄存器**R8_fiq~R12_fiq**；
* 当使用除fiq模式以外的**其他模式时**，访问寄存器**R8_usr~R12_usr**。

#### R13、R14

对于R13、R14来说，每个寄存器对应6个不同的物理寄存器，其中的一个是用户模式与系统模式共用，另外5个物理寄存器对应于其他5种不同的运行模式，采用以下的记号来区分不同的物理寄存器:

`R13_<mode>`
`R14_<mode>`

其中，mode为以下几种模式之一：usr、fiq、irq、svc、abt、und。

1. **寄存器R13**

* 在ARM指令中常用作堆栈指针，但这只是种习惯用法，用户也可使用其他的寄存器作为堆栈指针。
* 而在Thumb指令集中,某些指令强制性的要求使用R13作为堆栈指针。

  由于处理器的每种运行模式均有自己独立的物理寄存器R13，在用户应用程序的初始化部分，一般都要初始化每种模式下的R13，使其指向该运行模式的栈空间，这样，当程序的运行进入异常模式时，可以将需要保护的寄存器放入R13所指向的堆栈，而当程序从异常模式返回时，则从对应的堆栈中恢复，采用这种方式可以保证异常发生后程序的正常执行。

2. **寄存器R14**

   R14也称为**子程序链接寄存器**(Subroutine Link Register)或**链接寄存器LR**。

* 当执行BL子程序调用指令时，R14中得到R15(程序计数器PC)的备份。
* 其他情况下,R14用作通用寄存器。与其类似，当发生中断或异常时，对应的分组寄存器R14_svc、R14_irq、R14_fiq、R14_abt和R14_und用来保存R15的返回值。

    ◆ 寄存器R14常用在如下的情况：

  * 在每一种运行模式下，都可用R14保存子程序的返回地址，当用BL或BLX指令调用子程序时，将PC的当前值复制给R14，执行完子程序后，又将R14的值复制回PC，即可完成子程序的调用返回。
  * R14也可用作**通用寄存器**

#### ** 程序计数器 **

**寄存器R15用作程序计数器(PC)**。
* 在ARM状态下，位[1:0]为0，位[31:2]用于保存PC；
* 在Thumb状态下，位[0]为0，位[31:1]用于保存PC。

R15**也可用作通用寄存器**，但一般不这么使用，因为对R15的使用有些特殊的限制，当违反了这些限制时，程序的执行结果是未知的。

由于ARM体系结构采用了多级流水线技术，对于ARM指令集而言，**PC总是指向当前指令的下两条指令的地址，即PC的值为当前指令的地址值加8个字节**。

<!-- tabs:end -->

#### 2 CPSR和SPSR

* **CPSR → 当前程序状态寄存器**（current program status register）
  是在任何运行模式下都可以访问的**通用状态寄存器**，它包括<u>条件标志位</u>、<u>中断禁止位</u>、<u>当前处理器模式标志位</u>、<u>以及其他一些相关的控制和状态位</u>。

* **SPSR → 备份的程序状态寄存器**（saved program status register）
  为了安全的进行中断处理，各种异常模式都有一个专用的物理状态寄存器**SPSR**，这个寄存器的作用是:当处理器响应异常中断时，处理器硬件自动把当前CPSR的状态存储到SPSR中去，以免中断处理程序在使用CPSR时改变原来的状态，对中断返回造成影响。而在中断返回时，程序要使用一条指令把SPSR中保存的内容恢复到CPSR中去。
  
  例如: `MOV PC,LR`

* 由于**用户模式**和**系统模式**不属于异常模式，它们**没有SPSR**，因此当在这两种模式下访问SPSR，结果是未知的。


在ARM状态下，任一时刻可以访问以上所讨论的16个通用寄存器和一到两个状态寄存器。
在非用户模式（特权模式）下，则可访问到特定模式分组寄存器，图2-4说明在每一种运行模式下，哪一些寄存器是可以访问的。

![图 2-4](pictures\图2_4.png)